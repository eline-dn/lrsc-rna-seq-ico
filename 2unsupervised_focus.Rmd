---
title: "2unsupervised_focus"
output: html_document
date: "2025-07-30"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = "/media/labct/P4/Single_cell_rna_seq_analyses_eline/sc3samples_whitelist")
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
ordi="inserm-root"
dir.create(paste0("/media/",ordi,"/P4/Single_cell_rna_seq_analyses_eline/sc3samples_whitelist/no_ribo_hist"))
rootdir=paste0("/media/",ordi,"/P4/Single_cell_rna_seq_analyses_eline/sc3samples_whitelist/no_ribo_hist/unsupervised")
setwd(rootdir)  # Set this to correct location
#source("/media/labct/P4/Single_cell_rna_seq_analyses_eline/project/R/seurat_processing.R")
source(paste0("/media/",ordi,"/P4/Single_cell_rna_seq_analyses_eline/project/R/DE-analysis.R"))
source(paste0("/media/",ordi,"/P4/Single_cell_rna_seq_analyses_eline/project/R/visualisation_tools_and_pathway_analysis.R"))
library(ComplexHeatmap)
library(circlize)
library(enrichR)
```



```{r}
merged_iso<-readRDS(paste0("/media/",ordi,"/P4/Single_cell_rna_seq_analyses_eline/sc3samples_whitelist/no_ribo_hist/merge_integration/regressed_obj_isoform.rds"))
merged_gene<-readRDS(paste0("/media/",ordi,"/P4/Single_cell_rna_seq_analyses_eline/sc3samples_whitelist/no_ribo_hist/merge_integration/regressed_obj_gene.rds"))

merged_iso$sample <- factor(merged_iso$sample , levels = c("ctrl", "S24", "R"))
merged_gene$sample <- factor(merged_gene$sample , levels = c("ctrl", "S24", "R"))
```

méthode de regression sur les gènes histo et ribo choisie: ? on retire les histo/ribo
intégration: non
cf ggdocs pour expliquer méthode en détail. 


il faut d'abord relier les cellules au clustering fait dans le gene level:

```{r}
df<-as.data.frame(merged_gene$clusters)
colnames(df)<-c("gene_clusters")
df$cell_names<-rownames(df)

df2<-as.data.frame(merged_iso$clusters)
colnames(df2)<-c("iso_clusters")
df2$cell_names<-rownames(df2)

df<-df|> full_join(df2, by=("cell_names"))
head(df)


merged_iso$cell_names<-rownames(merged_iso[[]])
merged_iso[[]]<-merged_iso[[]] |> left_join(df[,c("gene_clusters","cell_names")], by="cell_names") 
```





tracer dimplot pour visualiser les clsuters_gene sur umap gene et iso
```{r}
DimPlot(merged_gene, group.by=c("clusters","sample"),combine = TRUE) +labs(caption = "Clustering and sample repartition at gene level")


DimPlot(merged_iso, group.by=c("gene_clusters","sample"),combine = TRUE) +labs(caption = "Clustering and sample repartition at isoform level")

```
# 1 extracting the over-expressed genes in each cluster in each condition

function to extract the genes:

```{r}

DE_split<-function(seu_obj,
                     overexpressed=TRUE,
                     name="",
                   outdir=paste0(rootdir,"/unsupervised2")) {
sub_list<-SplitObject(seu_obj, split.by = "sample")

df_list<-lapply(names(sub_list), function(sample_name) {
 # sample_name="R" #(tests)
  
  seu_obj<-sub_list[[sample_name]]
  
  Idents(seu_obj)<-"clusters"
  gene_mark<-FindAllMarkers(seu_obj, do.print = FALSE,
                            assay="SCT", slot="data",
                            logfc.threshold = 0.5, min.pct = 0.10,
                            only.pos = FALSE) %>% 
    dplyr::filter(p_val_adj < 0.05) %>% 
      filter(case_when(
        overexpressed ~ avg_log2FC > 0,
        !overexpressed ~ avg_log2FC < 0)) %>%
    mutate(sample=sample_name)
      return(gene_mark)
    
  })

df<-bind_rows(df_list)
write_csv(df,file =paste0(outdir,"/df_genes_", name,"_percluster_splitpersample.csv") )
return(df)}

```

```{r}
outdir=paste0(rootdir,"/unsupervised2")
dir.create(outdir)
df<-DE_split(merged_gene, name = "overexpressed")
```



# 2 a cluster expressing a constant and visible identity: cluster 3 (ferroptosis)


```{r}
df3<-df %>%
  filter(cluster==3)
# extract common genes:

list<-lapply(c("ctrl", "S24","R"), function(sample_name){
  gene_list<-df3 %>%
    filter(sample==sample_name) %>%
    pull(gene)
  return(gene_list)
})

inter_list<-intersect(list[[1]], list[[2]])
inter_list<-intersect(inter_list, list[[3]])
print(inter_list)

writeLines(inter_list, paste0(outdir,"/3/genes_communs_3samples_cluster3.txt"))

# sans filter les isoformes à plotter:
dir.create(paste0(outdir,"/3"))
for (gene in inter_list) {
  plot_feature_iso(merged_iso, gene,
                   sample_name="unfiltered",
                   output_dir = paste0(outdir,"/3"))
}

# en filtrant les isoformes à plotter

df_filtered<-filter_relevant_iso(merged_iso, more_than_one_iso = T, list=inter_list, output=paste0(outdir,"/3"))
dot_plot_switch(merged_iso, more_than_one_iso = T,filtered_genes_df = df_filtered, output_dir = paste0(outdir,"/3"))
for (gene in inter_list) {
  plot_feature_iso2(merged_iso, gene,
                   sample_name="filtered",
                   output_dir = paste0(outdir,"/3"),
                   marker_list = df_filtered$feature,
                   label=F)
}

writeLines(df_filtered$feature, paste0(outdir,"/3/iso_filtres_communs_3samples_cluster3.txt"))
```

comparaison avec les isoformes différentiellement exprimés  entre les conditions au sein du cluster 3? 


```{r}
Idents(merged_iso)<-"gene_clusters"
so_list<- SplitObject(merged_iso)
sub3<-so_list[["3"]]
Idents(sub3)<-"sample"
sub3<-PrepSCTFindMarkers(sub3, assay="SCT")
all_markers<-FindAllMarkers(sub3,logfc.threshold = 1) %>% 
  filter(p_val_adj<0.05)

#then heatmap on the features identified previously:

heatmap<-DoHeatmap(sub3, slot="data", 
                     assay="SCT",
                     features =  df_filtered$feature,
                   group.by = "sample") + labs(caption = paste0("Top markers for each sample at isoform level"))
  heatmap
   ggsave(filename=paste0(outdir,"/3/heatmap_filtered_markers_.png"),
         heatmap)
  

# pas super convaincant (plus parlant sur le dotplot)
   
   
# do we get the same results if we filter the isoforms of the most DEed isoforms
  all_markers %>%
    group_by(cluster) %>%
    dplyr::filter(avg_log2FC > 1) %>%
    slice_head(n = 15) %>%
    ungroup() -> top_markers
  
  
  heatmap<-DoHeatmap(sub3, slot="data", 
                     assay="SCT",
                     features =  top_markers$gene,
                   group.by = "sample") + labs(caption = paste0("Top markers for each sample at isoform level"))
  heatmap
  
 ggsave(filename=paste0(outdir,"/3/heatmap_top_markers_.png"),
         heatmap)
 
 # list of genes of interest
 
markers<- all_markers%>%
   filter(avg_log2FC >2) %>%
   group_by(cluster) %>%
   slice_max(order_by = avg_log2FC, n=100) %>%
   mutate(
      gene_name = sub(".*--", "",gene))|> 
    mutate(transcript_id=sub("--.*", "",gene)) 
  
write_csv(markers, file = paste0(outdir,"/3/de_iso/transcrits_de.csv"))
gene_list<-markers %>% 
  count(gene_name) %>%
  filter(n > 1) %>%
  pull(gene_name)
   
 writeLines(gene_list, paste0(outdir,"/3/de_iso/genes_transcrits_de.txt"))

 
 
 # en filtrant les isoformes à plotter
dir.create(paste0(outdir,"/3/de_iso"))
df_filtered<-filter_relevant_iso(merged_iso, more_than_one_iso = T, list=gene_list, output = paste0(outdir,"/3/de_iso"))
df_filtered<- df_filtered %>%
  filter(feature %in% markers$gene)
write_csv(df_filtered, file=paste0(outdir,"/3/de_iso/df_filtered_avec_que_iso_de.csv"))
dot_plot_switch(merged_iso, more_than_one_iso = T,filtered_genes_df = df_filtered, output_dir = paste0(outdir,"/3/de_iso"))

for (gene in unique(df_filtered$gene_name)) {
  plot_feature_iso2(merged_iso, gene,
                   sample_name="filtered",
                   output_dir = paste0(outdir,"/3/de_iso"),
                   marker_list = df_filtered$feature,
                   label=F)
}
```

we don't find the same genes and isoforms as with the previous approach but ok

à part NQO1, les gènes ne sont pas spécifiques au clsuter 3



# 3: clusters experiencing a strong identity switch
compare genes and isoforms from the different phase with the others
extract genes from the switching condition, filter them and feature plot
```{r}
df<-DE_split(merged_gene, name = "overexpressed")
```

## cluster 0 expresses a different signature in resistant cells. 

could be interesting to look a the genes conserved accross the sample and the identity switch 
or the genes over expressed in the resistant cells 
```{r}
df0<-df %>%
  filter(cluster==0)
# extract common genes:

list<-lapply(c("ctrl", "S24","R"), function(sample_name){
  gene_list<-df0 %>%
    filter(sample==sample_name) %>%
    pull(gene)
  return(gene_list)
})
names(list)<-c("ctrl", "S24","R")
### genes conserved accross the sample and the identity switch 
#inter_list<-intersect(list[[1]], list[[2]])
#inter_list<-intersect(inter_list, list[[3]])
inter_list<-intersect(list[[3]], list[[2]])
print(inter_list)
writeLines(inter_list,paste0(outdir,"/0/conserved/conserved_genes_3samples.txt"))

# sans filter les isoformes à plotter:
dir.create(paste0(outdir,"/0/conserved"))
for (gene in inter_list) {
  plot_feature_iso(merged_iso, gene,
                   sample_name="unfiltered_conserved_genes",
                   output_dir = paste0(outdir,"/0/conserved"))
}

# en filtrant les isoformes à plotter

df_filtered<-filter_relevant_iso(merged_iso, more_than_one_iso = T, list=inter_list, output = paste0(outdir,"/0/conserved"))
dot_plot_switch(merged_iso, more_than_one_iso = T,filtered_genes_df = df_filtered, output_dir = paste0(outdir,"/0/conserved"))
for (gene in unique(df_filtered$gene_name)) {
  plot_feature_iso2(merged_iso, gene,
                   sample_name="filtered_conserved_genes",
                   output_dir = paste0(outdir,"/0/conserved"),
                   marker_list = df_filtered$feature,
                   label=T)
}


```
pas trop de switch mais on pouvait s'y attendre, bien spécifique à 0 

```{r}

res_list<-setdiff(list[["R"]],union(list[["ctrl"]],list[["S24"]]))
writeLines(res_list, paste0(outdir,"/0/res/genes_resistant_cells.txt"))
###the genes over expressed in the resistant cells 

# sans filter les isoformes à plotter:
dir.create(paste0(outdir,"/0/res"))
#for (gene in res_list) {
  #plot_feature_iso(merged_iso, gene,
                   #sample_name="unfiltered",
              #     output_dir = paste0(outdir,"/0/res"))
#}

# en filtrant les isoformes à plotter

df_filtered<-filter_relevant_iso(merged_iso, more_than_one_iso = T, list=res_list, output=paste0(outdir,"/0/res"))
dot_plot_switch(merged_iso, more_than_one_iso = T,filtered_genes_df = df_filtered, output_dir = paste0(outdir,"/0/res"))

for (gene in unique(df_filtered$gene_name) ){
  plot_feature_iso2(merged_iso, gene,
                   sample_name="filtered",
                   output_dir = paste0(outdir,"/0/res"),
                   marker_list = df_filtered$feature,
                   label=T)
}

print(length(unique(df_filtered$gene_name)))
```

les gènes ne clusterisent pas bcp en 0 :( (mais un peu qd même)

liste de 32 gènes mais on peux par exemple se concentrer sur ceux qui on des isoformes déjà décrits? 


```{r}


described_iso_genes<-unique(df_filtered$gene_name[which(!str_detect(df_filtered$transcript_id, pattern = "-"))])
#described_iso<-df_filtered$feature[which(!str_detect(df_filtered$transcript_id, pattern = "-"))]
described_df<-df_filtered[which(!str_detect(df_filtered$transcript_id, pattern = "-")),1:4]
# à refiltrer sur le nombre de gènes
write_csv(described_df,paste0(outdir,"/0/described_iso_res/descibed_df.csv") )
described_iso_genes<-described_df %>%
  group_by(gene_name) %>%
    summarise(n_isoforms = n_distinct(transcript_id)) %>%
    filter(n_isoforms>=2)%>%
    pull(gene_name)

described_features<-described_df%>%
  filter(gene_name %in% described_iso_genes)%>%
  pull(feature)
 
length(described_iso_genes)

Idents(merged_iso)<-"gene_clusters"

for (gene in described_iso_genes ){
  plot_feature_iso2(merged_iso, gene,
                   sample_name="filtered_known",
                   output_dir = paste0(outdir,"/0/described_iso_res"),
                   marker_list = described_features,
                   label=T)
}

```





## cluster 5 expresses a transitory identity switch during the acute phase (S24 sample), and has a signature strongly associated with apoptosis. 

could be interesting to look a the genes conserved accross the sample and the identity switch 
or the genes over expressed in the resistant cells 
```{r}
df0<-df %>%
  filter(cluster==5)
# extract common genes:

list<-lapply(c("ctrl", "S24","R"), function(sample_name){
  gene_list<-df0 %>%
    filter(sample==sample_name) %>%
    pull(gene)
  return(gene_list)
})
names(list)<-c("ctrl", "S24","R")

```

```{r}

### genes specific to  the identity switch 
switch_genes<-setdiff(list[["S24"]], union(list[["ctrl"]], list[["R"]]))
print(switch_genes)
writeLines(switch_genes,paste0(outdir,"/5/switch/genes_S24phase.txt") )
# sans filter les isoformes à plotter:
dir.create(paste0(outdir,"/5/switch"))
for (gene in switch_genes) {
  #plot_feature_iso(merged_iso, gene,
                   #sample_name="unfiltered",
                  # output_dir = paste0(outdir,"/5/switch"))
   plot( FeaturePlot(merged_gene,features = gene,combine=TRUE,split.by="sample",label=TRUE))

}

# en filtrant les isoformes à plotter

df_filtered<-filter_relevant_iso(merged_iso, more_than_one_iso = T, list=switch_genes, output = paste0(outdir,"/5/switch"))
dot_plot_switch(merged_iso, more_than_one_iso = T,filtered_genes_df = df_filtered, output_dir = paste0(outdir,"/5/switch"))
for (gene in unique(df_filtered$gene_name)) {
  plot_feature_iso2(merged_iso, gene,
                   sample_name="filtered",
                   output_dir = paste0(outdir,"/5/switch"),
                   marker_list = df_filtered$feature,
                   label=T)
}


```

```{r}

res_list<-setdiff( intersect(list[["ctrl"]], list[["R"]]),list[["S24"]])
print(res_list)
###the genes over expressed in the resistant AND control cells but not in the S24 cells 
# sans filter les isoformes à plotter:
dir.create(paste0(outdir,"/5/ctrl_r"))
for (gene in res_list) {
  plot_feature_iso(merged_iso, gene,
                   sample_name="unfiltered",
                 output_dir = paste0(outdir,"/5/ctrl_r"))
}
writeLines(res_list,paste0(outdir,"/5/ctrl_r/genes_not_filtered.txt"))

# en filtrant les isoformes à plotter

df_filtered<-filter_relevant_iso(merged_iso, more_than_one_iso = T, list=res_list, output=paste0(outdir,"/5/ctrl_r"))
dot_plot_switch(merged_iso, more_than_one_iso = T,filtered_genes_df = df_filtered, output_dir = paste0(outdir,"/5/ctrl_r"))
for (gene in unique(df_filtered$gene_name) ){
  plot_feature_iso2(merged_iso, gene,
                   sample_name="filtered",
                   output_dir = paste0(outdir,"/5/ctrl_r"),
                   marker_list = df_filtered$feature,
                   label=T)
}


```

```{r}

res_list<-setdiff( union(list[["ctrl"]], list[["R"]]),list[["S24"]])
print(res_list)
writeLines(res_list,paste0(outdir,"/5/ctrlorr/genes_not_filt.txt") )
###the genes over expressed in the resistant OR control cells but not in the S24 cells 
# sans filter les isoformes à plotter:
dir.create(paste0(outdir,"/5/ctrlorr"))
for (gene in res_list) {
  plot_feature_iso(merged_iso, gene,
                   sample_name="unfiltered",
                 output_dir = paste0(outdir,"/5/ctrlorr"))
}

# en filtrant les isoformes à plotter

df_filtered<-filter_relevant_iso(merged_iso, more_than_one_iso = T, list=res_list, output = paste0(outdir,"/5/ctrlorr"))
dot_plot_switch(merged_iso, more_than_one_iso = T,filtered_genes_df = df_filtered, output_dir = paste0(outdir,"/5/ctrlorr"))
for (gene in unique(df_filtered$gene_name) ){
  plot_feature_iso2(merged_iso, gene,
                   sample_name="filtered",
                   output_dir = paste0(outdir,"/5/ctrlorr"),
                   marker_list = df_filtered$feature,
                   label=T)
}
length(unique(df_filtered$gene_name))

```

liste de 16 gènes mais on peux par exemple se concentrer sur ceux qui on des isoformes déjà décrits? 


```{r}
str_which(df_filtered$transcript_id, pattern = "-")
which(!str_detect(df_filtered$transcript_id, pattern = "-"))

described_iso_genes<-unique(df_filtered$gene_name[which(!str_detect(df_filtered$transcript_id, pattern = "-"))])
#described_iso<-df_filtered$feature[which(!str_detect(df_filtered$transcript_id, pattern = "-"))]
described_df<-df_filtered[which(!str_detect(df_filtered$transcript_id, pattern = "-")),1:4]
# à refiltrer sur le nombre de gènes

described_iso_genes<-described_df %>%
  group_by(gene_name) %>%
    summarise(n_isoforms = n_distinct(transcript_id)) %>%
    filter(n_isoforms>=2)%>%
    pull(gene_name)

described_features<-described_df%>%
  filter(gene_name %in% described_iso_genes)%>%
  pull(feature)
 
length(described_iso_genes)
write_csv(described_df, file = paste0(outdir,"/5/ctrlorr/described_df.csv"))
Idents(merged_iso)<-"gene_clusters"

for (gene in described_iso_genes ){
  plot_feature_iso2(merged_iso, gene,
                   sample_name="filtered_known",
                   output_dir = paste0(outdir,"/5/ctrlorr/described_iso"),
                   marker_list = described_features,
                   label=T)
}

```

# 4 resistant clusters 456


=> we want to find something to characterize these clusters and resistance traits 
cf the heatmaps: some specific pathways seem to be underexpressed
=> either: extract the common pathways, find the associated genes and filter their isoforms and feature plot
=> or: split per sample, find the common under-expressed genes in these clusters, filter their isoforms and feature plots

## common under-expressed genes
```{r}
df<-DE_split(merged_gene, name = "underexpressed", overexpressed = F)

```


```{r eval=FALSE}
df0<-df %>%
  filter(cluster==5 | cluster==4 |cluster==6)
# extract common genes:

list<-lapply(c("4", "5","6"), function(clust_name){
  gene_list<-df0 %>%
    filter(cluster==clust_name) %>%
    pull(gene)
  return(gene_list)
})
names(list)<-c("4", "5","6")
### genes conserved accross the sample and the identity switch 
inter_list<-intersect(list[[1]], list[[2]])
inter_list<-intersect(inter_list, list[[3]])
print(inter_list)

# sans filter les isoformes à plotter:
dir.create(paste0(outdir,"/5"))
for (gene in inter_list) {
  plot_feature_iso(merged_iso, gene,
                   sample_name="unfiltered",
                   output_dir = paste0(outdir,"/5"))
}

# en filtrant les isoformes à plotter

df_filtered<-filter_relevant_iso(merged_iso, more_than_one_iso = T, list=inter_list)
dot_plot_switch(merged_iso, more_than_one_iso = T,filtered_genes_df = df_filtered, output_dir = paste0(outdir,"/5"))
for (gene in inter_list) {
  plot_feature_iso2(merged_iso, gene,
                   sample_name="filtered",
                   output_dir = paste0(outdir,"/5"),
                   marker_list = df_filtered$feature,
                   label=F)
}


```
test de la première approche: DE split et inter des gènes en communs: l'intersection est vide

variante avec DE sur le set total: voir downstream_analysis_unsupervised.Rmd: on obtiens qq gènes 


## extract the common pathways, find the associated genes and filter their isoforms and feature plot


```{r}

#noms<-c("whole_set","ctrl","S24","R")
noms<-c("whole_set") 
# penser à modifier le seuil pour le nombre de fois où le terme est retrouvé aussi
list<-lapply(noms, function(x) {
  df<-read_csv(paste0("/media/inserm-root/P4/Single_cell_rna_seq_analyses_eline/sc3samples_whitelist/no_ribo_hist/unsupervised/enrichment_per_cluster_",x,"_underexpressed_genes.csv"))
  df<-df%>%
    mutate(sample=x)%>%
    filter(Adjusted.P.value < 0.05)
  return(df)
})
names(list)<-noms

enrich_df<-bind_rows(list)

# for each clusters, we want the terms shared by several conditions :
  # common pathways
shared_pathways<-lapply(4:6, function(x){

pathway_counts <- table(enrich_df%>%
                          filter(cluster==x)%>%
                          pull(Term))
return(names(pathway_counts[pathway_counts >= 1]))
})
names(shared_pathways)<-4:6
#terms shared between the clusters in several conditions
inter<-intersect(shared_pathways[["4"]],shared_pathways[["5"]])
inter<-intersect(inter,shared_pathways[["6"]])

# associated genes


genes<- enrich_df%>%
  filter(Term %in% inter) %>%
  pull(Genes)
gene_list <-unique( unlist(str_split(genes,pattern=";")))

print(gene_list)

  

```

filter isoforms and feature plots

```{r eval=FALSE}

# sans filter les isoformes à plotter:
output<-paste0(outdir,"/intersection")
dir.create(output)
for (gene in gene_list) {
  plot_feature_iso(merged_iso, gene,
                   sample_name="unfiltered",
                 output_dir = output)
}
```

```{r}
output<-paste0(outdir,"/intersection")

writeLines(gene_list, paste0(output,"/genes_shared_pathways.txt"))
writeLines(shared_pathways[["4"]], paste0(output,"/genes_shared_pathways4.txt"))
writeLines(shared_pathways[["5"]], paste0(output,"/genes_shared_pathways5.txt"))
writeLines(shared_pathways[["6"]], paste0(output,"/genes_shared_pathways6.txt"))

# en filtrant les isoformes à plotter

df_filtered<-filter_relevant_iso(merged_iso, more_than_one_iso = T, list=gene_list, output = output)
dim(df_filtered%>% count(gene_name))

dot_plot_switch(merged_iso, more_than_one_iso = T,filtered_genes_df = df_filtered, output_dir = output)

Idents(merged_iso)<-"gene_clusters"
for (gene in unique(df_filtered$gene_name) ){
  plot_feature_iso2(merged_iso, gene,
                   sample_name="filtered",
                   output_dir = output,
                   marker_list = df_filtered$feature,
                   label=F)
}




```
liste de 211 gènes mais on peux par exemple se concentrer sur ceux qui on des isoformes déjà décrits? 


```{r}
str_which(df_filtered$transcript_id, pattern = "-")
which(!str_detect(df_filtered$transcript_id, pattern = "-"))

described_iso_genes<-unique(df_filtered$gene_name[which(!str_detect(df_filtered$transcript_id, pattern = "-"))])
#described_iso<-df_filtered$feature[which(!str_detect(df_filtered$transcript_id, pattern = "-"))]
described_df<-df_filtered[which(!str_detect(df_filtered$transcript_id, pattern = "-")),1:4]
# à refiltrer sur le nombre de gènes

described_iso_genes<-described_df %>%
  group_by(gene_name) %>%
    summarise(n_isoforms = n_distinct(transcript_id)) %>%
    filter(n_isoforms>=2)%>%
    pull(gene_name)

described_features<-described_df%>%
  filter(gene_name %in% described_iso_genes)%>%
  pull(feature)
write_csv(described_df, file =  paste0(output,"/described_iso/described_df.csv"))
 
length(described_iso_genes)

Idents(merged_iso)<-"gene_clusters"

for (gene in described_iso_genes ){
  plot_feature_iso2(merged_iso, gene,
                   sample_name="filtered_known",
                   output_dir = paste0(output,"/described_iso"),
                   marker_list = described_features,
                   label=T)
}

```

